
import requests
import pandas as pd
from datetime import date, timedelta

# Function to get COVID-19 testing data from the specified API
def get_testing_data():
    url = "https://healthdata.gov/resource/j8mb-icvb.json"
    response = requests.get(url, verify=False)
    data = response.json()
    return data

# Function to calculate the total number of PCR tests performed as of yesterday
def total_pcr_tests(data):
    pcr_tests = sum(int(entry['total_results_reported']) for entry in data)
    return pcr_tests



# Function to calculate the 7-day rolling average number of new cases per day for the last 30 days
def rolling_average_new_cases(data):
    df = pd.DataFrame(data)
    df['date'] = pd.to_datetime(df['date'])
    df = df.sort_values('date')
    df['new_cases'] = df['new_results_reported'].astype(int)
    rolling_avg = df['new_cases'].rolling(window=7).mean()
    last_30_days_avg = rolling_avg.tail(30).mean()
    return last_30_days_avg

# Function to calculate the 10 states with the highest test positivity rate for tests performed in the last 30 days
def highest_test_positivity_states(data):
    df = pd.DataFrame(data)
    df['date'] = pd.to_datetime(df['date'])
    df = df.sort_values('date')
    last_30_days_data = df[df['date'] >= (pd.Timestamp(date.today()) - timedelta(days=30))]
    print("last_30_days_data")
    print(last_30_days_data)
    last_30_days_data['test_positivity_rate'] = pd.to_numeric(last_30_days_data['new_results_reported']) / pd.to_numeric(last_30_days_data['total_results_reported'])
    print("last_30_days_data test_positivity_rate")
    print(last_30_days_data['test_positivity_rate'])
    top_10_states = last_30_days_data.groupby('state').mean()['test_positivity_rate'].nlargest(10)
    print("top_10_states")
    print(top_10_states)
    top_10_states_names = top_10_states.index.tolist()
    return top_10_states_names

# Function to calculate the 10 states with the highest test positivity rate based on all available data dates





# Main function to run the analysis
def main():
    data = get_testing_data()
    
    
    total_pcr_tests_result = total_pcr_tests(data)
    print(f"Total number of PCR tests performed as of yesterday: {total_pcr_tests_result}")
    
    rolling_avg_new_cases = rolling_average_new_cases(data)
    print(f"7-day rolling average number of new cases per day for the last 30 days: {rolling_avg_new_cases}")
    
    
    highest_test_positivity_states_result = highest_test_positivity_states(data)
    print("Top 10 states with the highest test positivity rate in the last 30 days:")
    print(highest_test_positivity_states_result)
    for state in highest_test_positivity_states_result:
        print(state)

if __name__ == "__main__":
    main()


